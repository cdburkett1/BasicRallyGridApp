<!DOCTYPE html>
<html>
<head>
    <title>Defect Counts by Release</title>

    <script type="text/javascript" src="/apps/2.0rc1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",items:[{layout:"hbox",border:!1,items:[{xtype:"container",itemId:"chart1",flex:1},{xtype:"container",itemId:"chart2",flex:1}]},{layout:"hbox",border:!1,items:[{xtype:"component",itemId:"text1",html:'<div style="float:left; clear:both; width:600px"><p><b>Release Defects by State</b> displays counts of all defects in the release based on their current state.</p></div>'},{xtype:"component",itemId:"text2",html:'<div style="float:left; clear:both; width:600px"><p><b>Current Active Defects by Priority</b> takes all active (not in a closed state) defects for the current release and displays counts of those defects based on priority.</p></div>'}]}],launch:function(){this.relCB=window.parent.Ext4.ComponentQuery.query("rallyreleasecombobox")[0],this.relCB.on({select:this._onReleaseSelect,ready:this._onReleaseSelect,scope:this}),this._onReleaseSelect()},_onReleaseSelect:function(){this.gRelease=null;var value=this.relCB.getRecord();this.gRelease=value.data.ObjectID;var that=this;Ext.create("Rally.data.WsapiDataStore",{model:"Defect",autoLoad:!0,listeners:{load:that._aggregateData,scope:that},fetch:["ObjectID","Name","State","Release","Priority"],hydrate:["State"],filters:[{property:"Release.ObjectID",value:that.gRelease}]})},_aggregateData:function(store,data,success){for(var that=this,stateData=[],priorityData=[],states=["Submitted","Open","Re-opened","Test-Dev","Test-QA","Closed"],priorities=["Critical","High","Medium","Low","None"],colors=["#f68d86","#ea9861","#ead960","#88c197","#7daed5","#c188b2"],i=0;states.length>i;i++)stateData.push({name:states[i],y:0,color:colors[i]});for(var j=0;priorities.length>j;j++)priorityData.push({name:priorities[j],y:0,color:colors[j]});_.each(data,function(d){++stateData[_.indexOf(states,d.data.State)].y,"Closed"!==d.data.State&&++priorityData[_.indexOf(priorities,d.data.Priority)].y}),that._showCharts(stateData,priorityData)},_showCharts:function(stateData,priorityData){var that=this,chart1=this.down("#chart1"),chart2=this.down("#chart2");chart1.removeAll(),chart2.removeAll();for(var totalDefects=0,totalActiveDefects=0,i=0;stateData.length>i;i++)totalDefects+=stateData[i].y;for(var j=0;priorityData.length>j;j++)totalActiveDefects+=priorityData[j].y;var extChart1=Ext.create("Rally.ui.chart.Chart",{width:600,height:400,chartData:{series:[{type:"pie",name:"Defect Count",data:stateData}]},chartConfig:{chart:{plotBackgroundColor:null,plotBorderWidth:null,plotShadow:!1},title:{text:"Release Defects by State",style:{color:"#000000"}},subtitle:{text:"Total Defects: "+totalDefects,style:{color:"#000000"}},tooltip:{pointFormat:"{series.name}: <b>{point.y}</b>"},plotOptions:{pie:{allowPointSelect:!1,cursor:"pointer",dataLabels:{enabled:!0,useHTML:!0,color:"#000000",connectorColor:"#000000",formatter:function(){return 0===this.y?null:"<div><b>"+this.point.name+"</b>: "+this.y+"</div>"}},point:{events:{click:function(event){var pointRef=this;Ext.create("Rally.data.WsapiDataStore",{model:"Defect",autoLoad:!0,listeners:{load:function(store,data,success){var text="";_.each(data,function(d){text+='<a href="'+Ext.String.format("https://rally1.rallydev.com/#/detail{0}",d.data._ref)+'" target="_blank">'+d.data.FormattedID+"</a>: "+d.data.Name+"<br />"});var win;if(!win){var form=Ext.widget("form",{autoScroll:!0,layout:{type:"vbox",aligh:"stretch"},border:!1,bodyPadding:10,fieldDefaults:{labelAlign:"top",labelWidth:100,labelStyle:"font-weight:bold"},items:[{xtype:"displayfield",value:text}]}),pointName=pointRef.name;""===pointName&&(pointName="Not Specified"),win=Ext.widget("window",{title:"Defects with State: <b>"+pointName+"</b>",closeAction:"hide",width:800,height:400,layout:"fit",resizable:!0,modal:!0,items:form})}win.show()},scope:that},fetch:["ObjectID","Name","Release","State","FormattedID","_ref"],filters:[{property:"Release.ObjectID",value:that.gRelease},{property:"State",value:this.name}]})}}}}}}}),extChart2=Ext.create("Rally.ui.chart.Chart",{width:600,height:400,chartData:{series:[{type:"pie",name:"Defect Count",data:priorityData}]},chartConfig:{chart:{plotBackgroundColor:null,plotBorderWidth:null,plotShadow:!1},title:{text:"Current Active Defects by Priority",style:{color:"#000000"}},subtitle:{text:"Total Active Defects: "+totalActiveDefects,style:{color:"#000000"}},tooltip:{pointFormat:"{series.name}: <b>{point.y}</b>"},plotOptions:{pie:{allowPointSelect:!1,cursor:"pointer",dataLabels:{enabled:!0,useHTML:!0,color:"#000000",connectorColor:"#000000",formatter:function(){return 0===this.y?null:"<div><b>"+this.point.name+"</b>: "+this.y+"</div>"}},point:{events:{click:function(event){var pointRef=this;Ext.create("Rally.data.WsapiDataStore",{model:"Defect",autoLoad:!0,listeners:{load:function(store,data,success){var text="";_.each(data,function(d){text+='<a href="'+Ext.String.format("https://rally1.rallydev.com/#/detail{0}",d.data._ref)+'" target="_blank">'+d.data.FormattedID+"</a>: "+d.data.Name+"<br />"});var win;if(!win){var form=Ext.widget("form",{autoScroll:!0,layout:{type:"vbox",aligh:"stretch"},border:!1,bodyPadding:10,fieldDefaults:{labelAlign:"top",labelWidth:100,labelStyle:"font-weight:bold"},items:[{xtype:"displayfield",value:text}]}),pointName=pointRef.name;""===pointName&&(pointName="Not Specified"),win=Ext.widget("window",{title:"Defects with Priority: <b>"+pointName+"</b>",closeAction:"hide",width:800,height:400,layout:"fit",resizable:!0,modal:!0,items:form})}win.show()},scope:that},fetch:["ObjectID","Name","Release","Priority","State","FormattedID","_ref"],filters:[{property:"Release.ObjectID",value:that.gRelease},{property:"Priority",value:this.name},{property:"State",operator:"!=",value:"Closed"}]})}}}}}}});chart1.add(extChart1),chart2.add(extChart2);var p=Ext.get(chart1.id),elems=p.query("div.x-mask");_.each(elems,function(e){e.remove()}),elems=p.query("div.x-mask-msg"),_.each(elems,function(e){e.remove()}),p=Ext.get(chart2.id),elems=p.query("div.x-mask"),_.each(elems,function(e){e.remove()}),elems=p.query("div.x-mask-msg"),_.each(elems,function(e){e.remove()})}});

            Rally.launchApp('CustomApp', {
                name:"Defect Counts by Release",
	            parentRepos:"danallen88/defects-by-state"
            });

        });
    </script>


    <style type="text/css">
        .app {
}

    </style>
</head>
<body></body>
</html>

